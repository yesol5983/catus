# CATUS 서비스 전체 플로우

## 1. 서비스 개요

고양이 "달이"와 대화하며 감정 일기를 작성하는 서비스

**핵심 기능**
- AI 채팅: 달이와 대화 (프론트 비동기 DB 저장)
- 감정 분석: 대화 기반 자동 감정 추출
- 그림일기: AI가 대화 내용 기반 그림 생성
- 일기 관리: 캘린더 기반 조회
- 익명 응원: 랜덤 사용자와 일방적 메시지 전달
- 통계: 월별 감정 분포

---

## 2. 전체 사용자 여정

```
앱 접속 → 로그인 → 온보딩 → 홈 화면
                               ↓
              ┌────────────────┼────────────────┐
              ↓                ↓                ↓
            채팅             캘린더         익명응원
              ↓                ↓                ↓
      대화 분석 (백엔드)    일기 상세       일방적 메시지 
              ↓
   요약 + 감정 + 그림일기 생성
```

---

## 3. 주요 화면 플로우

### 3.1 로그인

```
앱 접속
  ↓
로그인 페이지
  ↓
"카카오로 시작하기" 클릭
  ↓
카카오 OAuth 인증
  ↓
code → POST /auth/kakao
  ↓
JWT 토큰 발급
  ↓
localStorage 저장
  ↓
온보딩 완료 확인
  ↓
┌─────────┬─────────┐
│  미완료  │  완료    │
↓         ↓
온보딩     홈 화면
```

**사용 API**
- `POST /auth/kakao`

**localStorage**
- `catus_access_token`: string


### 3.3 채팅 플로우 (비동기 DB 저장)

```
홈 → 채팅 페이지
  ↓
AI 인사 메시지
"안녕! 오늘 하루는 어땠어?"
  ↓
사용자 메시지 입력
  ↓
프론트 비동기 DB 저장
{
  role: "user",
  content: "오늘 힘든 일이 있었어",
  timestamp: "2024-11-20T12:34:56Z"
}
  ↓
POST /chat/message
{
  message: string,
  context: array (최근 5-10개 메시지)
}
  ↓
AI 응답 받기
  ↓
프론트 비동기 DB 저장
{
  role: "assistant",
  content: "무슨 일이 있었어?",
  timestamp: "2024-11-20T12:34:57Z"
}
  ↓
대화 계속...
  ↓
뒤로가기 클릭
  ↓
비동기 DB에서 전체 대화 조회 
  ↓
POST /chat/analyze
{
  date: "2024-11-20",
  messages: [
    { role: "user", content: "...", timestamp: "..." },
    { role: "assistant", content: "...", timestamp: "..." }
  ]
}
  ↓
백엔드 분석:
- 대화 요약 (2-3줄) [그림일기에서 일기부분]
- 감정 추출 [프롬프트로 5가지 감정 중 하나를 선택]
- 그림일기 이미지 생성 [대화내역 + 프롬프팅으로 그림일기 생성]
  ↓
일기 저장 (백엔드)
{
  diaryId: string,
  emotion: string,
  summary: string,
  pictureUrl: string
}
  ↓
홈 화면
```

**사용 API**
- `POST /chat/messages`: AI 응답 생성 (메시지 저장 안함)
- `POST /chat/analyze`: 대화 분석 및 일기 생성

**비동기 DB (IndexedDB)**
- Key: `date` (YYYY-MM-DD)
- Value: `messages[]`
  - `role`: "user" | "assistant"
  - `content`: string
  - `timestamp`: string (ISO 8601)

**감정 타입**
- "행복", "슬픔", "보통", "화남", "불안"

---

### 3.4 캘린더 플로우

```
홈 → 캘린더 페이지
  ↓
GET /diaries?year={year}&month={month}
  ↓
캘린더 표시 (감정별 색상 + 그림일기 썸네일) [감정이랑 그림 URL만 주면 색상은 프론트에서 설정]
  ↓
날짜 클릭
  ↓

일기 있음  
  ↓             
일기 상세      
GET /diaries/{date}
  ↓
일기 정보 표시:
- 날짜
- 감정
- 요약
- 그림일기
  ↓
┌────┬────┬────┐
│수정 │삭제 │닫기 │
```

**사용 API**
- `GET /diaries?year={year}&month={month}`: 월별 목록
- `GET /diaries/{date}`: 상세 조회
- `PUT /diaries/{date}`: 수정
- `DELETE /diaries/{date}`: 삭제

---

### 3.5 익명 응원 플로우

```
홈 → 익명 응원 페이지
  ↓
┌────────────┬────────────┐
│ 받은 메시지 │ 보낸 메시지 │
│             │            │
│ GET         │ GET        │
│ /support/   │ /support/  │
│ received    │ sent       │
└────────────┴────────────┘
  ↓
메시지 전송 버튼
  ↓
메시지 작성 (최대 100자)
  ↓
POST /support/send
  ↓
랜덤 사용자에게 전송
```

**사용 API**
- `GET /support/received`: 받은 메시지
- `POST /support/send`: 메시지 전송
- `PUT /support/{messageId}/read`: 읽음 처리

**특수 기능**
- 새 메시지 수신 시:
  - 홈 화면 고양이 → `cat_message.png`
  - 3번 클릭 → 편지 페이지 자동 이동
  - 처음 받은 경우 → 튜토리얼 팝업

---

## 4. 데이터 흐름

### 4.1 인증 토큰

```
카카오 로그인
  ↓
JWT 발급
  ↓
localStorage 저장 (catus_access_token)
  ↓
모든 API 요청 시
Authorization: Bearer {token}
  ↓
401 에러 시
  ↓
토큰 삭제 → 로그인 페이지
```

---

### 4.2 채팅 및 일기 데이터

```
[채팅 메시지]
사용자 입력 → 프론트 비동기 DB 저장
  ↓
POST /chat/message → AI 응답 (완료 시까지 대기)
  ↓
응답 수신 후 프론트 비동기 DB 저장
(백엔드는 메시지 저장 안함)

[대화 종료]
비동기 DB에서 전체 대화 조회
  ↓
POST /chat/analyze (전체 대화 전송)
  ↓
백엔드 분석:
- 요약 생성
- 감정 추출
- 그림일기 프롬프트 생성
- 이미지 생성 (DALL-E 등)
  ↓
일기만 백엔드 저장

[일기 조회]
캘린더 진입 → GET /diaries?year=...&month=...
  ↓
날짜 클릭 → GET /diaries/{date} (일기 정보)
  ↓
일기

[일기 삭제]
DELETE /diaries/{date} (백엔드)
  ↓
비동기 DB 삭제 (프론트)
```

---

### 4.3 익명 응원 메시지

```
[전송]
익명의 사용자 그림일기 뜸
  ↓
메시지 작성 → POST /support/send
  ↓
랜덤 사용자에게 전송

[수신]
백엔드 푸시 (선택)
  ↓
홈 화면 고양이 이미지 변경
  ↓
localStorage 업데이트

[조회]
페이지 진입 → GET /support/received
```

---

## 5. 저장소 관리

### 5.1 localStorage

| Key | Type | Description |
|-----|------|-------------|
| catus_access_token | string | JWT 토큰 |
| catus_onboarding_completed | boolean | 온보딩 완료 |
| received_messages | array | 받은 응원 |
| last_checked_received_count | int | 마지막 확인 개수 |
| support_tutorial_shown | boolean | 튜토리얼 표시 |
| dark_mode | boolean | 다크모드 |

---

### 5.2 비동기 DB (IndexedDB/AsyncStorage)

**Store: chat_messages**
| Field | Type | Description |
|-------|------|-------------|
| date | string (YYYY-MM-DD) | Primary Key |
| messages | array | 메시지 배열 |
| messages[].role | string | "user" \| "assistant" |
| messages[].content | string | 메시지 내용 |
| messages[].timestamp | string (ISO 8601) | 메시지 시간 |

**IndexedDB 구조 예시**
```javascript
{
  "2024-11-20": [
    {
      role: "user",
      content: "오늘 힘든 일이 있었어",
      timestamp: "2024-11-20T12:34:56Z"
    },
    {
      role: "assistant",
      content: "무슨 일이 있었어? 자세히 말해줄래?",
      timestamp: "2024-11-20T12:34:57Z"
    }
  ]
}
```

---

## 6. 화면 라우팅

```javascript
const ROUTES = {
  LOGIN: '/',
  HOME: '/home',
  CHAT: '/chat',
  CALENDAR: '/calendar',
  DIARY_DETAIL: '/diary/:date',
  SUPPORT: '/support',
  LETTER: '/letter',
  SETTINGS: '/settings',
  ONBOARDING: '/onboarding/start',
  ONBOARDING_FLOW: '/onboarding/flow'
};
```

---

## 7. 예외 처리

### 7.1 네트워크 오류
1. 에러 메시지 표시
2. 재시도 버튼 제공
3. 비동기 DB 데이터 유지

### 7.2 인증 만료 (401)
1. localStorage 토큰 삭제
2. 로그인 페이지 리다이렉트
3. 안내 메시지

### 7.3 중복 일기 생성
1. 백엔드 날짜 unique 제약
2. 에러 반환
3. 기존 일기로 리다이렉트

### 7.4 비동기 DB 동기화
1. 일기 삭제 시 비동기 DB도 함께 삭제
2. 앱 재설치 시 비동기 DB 초기화 (일기는 백엔드에서 복구 가능)

---

## 8. 그림일기 생성 플로우

```
대화 종료 → POST /chat/analyze
  ↓
백엔드에서 Gemini로 대화 분석
  ↓
그림일기 프롬프트 생성
(예: "밝은 햇살 아래 행복하게 웃는 고양이와 친구들")
  ↓
이미지 생성 API 호출 (DALL-E, Stable Diffusion 등)
  ↓
생성된 이미지 URL 저장
  ↓
일기와 함께 저장:
{
  pictureUrl: string
}
```

---

## 9. 통계 API (선택적)

### 9.1 감정 통계
```
GET /stats/emotions?year={year}&month={month}
```

**Response**
```typescript
{
  emotions: [
    {
      date: string (YYYY-MM-DD),
      emotion: string // "행복" | "슬픔" | "보통" | "화남" | "불안"
    }
  ]
}
```

---

### 9.2 월별 통계
```
GET /stats/monthly?year={year}&month={month}
```

**Response**
```typescript
{
  totalDiaries: int,
  mostFrequentEmotion: string,
  averageMessagesPerDay: float
}
```

---

## 10. 튜토리얼

### 10.1 메인 튜토리얼
**트리거**: 최초 홈 진입
**내용**:
1. 채팅 입력창
2. 일기 책
3. 선인장

### 10.2 응원 메시지 튜토리얼
**트리거**: 첫 메시지 수신
**내용**:
- 고양이 스팟라이트
- "달이를 3번 쓰다듬어 봐요"

---

## 11. Context 상태 관리

```
App
 ├─ AuthContext: 인증 상태
 ├─ UserContext: 사용자 정보
 ├─ DarkModeContext: 다크모드
 └─ TutorialContext: 튜토리얼
```

---

## 12. 성능 최적화

### 12.1 이미지
- WebP 포맷 사용
- 그림일기 썸네일 캐싱
- 반응형 srcset

### 12.2 API
- 월 변경 시에만 호출
- 비동기 DB 우선 조회 (채팅)

### 12.3 비동기 DB
- IndexedDB 사용 (브라우저/웹)
- AsyncStorage 사용 (React Native)
- 날짜별 자동 인덱싱
- 오래된 채팅 기록 자동 정리 (3개월 이상)

### 12.4 번들
- Code Splitting
- Lazy Loading
- Tree Shaking
